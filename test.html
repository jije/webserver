<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Toggle Button</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 40px;
      background: #f8f9fa;
    }

    .toggle-btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }

    .toggle-on {
      background-color: #4CAF50;
      color: white;
    }

    .toggle-off {
      background-color: #ccc;
      color: #333;
    }
  </style>
<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const source = audioCtx.createBufferSource();
const dryGain = audioCtx.createGain();
dryGain.gain.value = 0.7;
const wetGain = audioCtx.createGain();
wetGain.gain.value = 0.3;

// 오디오 소스 연결
fetch('test.mp3')
  .then(res => res.arrayBuffer())
  .then(buf => audioCtx.decodeAudioData(buf))
  .then(decoded => {
    source.buffer = decoded;
  });
  source.connect(audioCtx.destination);
  
function createRoomReverb() {
  const input = audioCtx.createGain();
  const output = audioCtx.createGain();

  const delay = audioCtx.createDelay();
  delay.delayTime.value = 0.015; // 15ms pre-delay

  const feedback = audioCtx.createGain();
  feedback.gain.value = 0.4; // Decay

  const damping = audioCtx.createBiquadFilter();
  damping.type = 'lowpass';
  damping.frequency.value = 5000;

  const wetGain = audioCtx.createGain();
  wetGain.gain.value = 0.2;

  input.connect(delay);
  delay.connect(damping);
  damping.connect(feedback);
  feedback.connect(delay); // feedback loop
  damping.connect(wetGain).connect(output);

  return { input, output };
}

function createHallReverb() {
  const input = audioCtx.createGain();
  const output = audioCtx.createGain();

  const delay = audioCtx.createDelay();
  delay.delayTime.value = 0.05; // 50ms pre-delay

  const feedback = audioCtx.createGain();
  feedback.gain.value = 0.75; // Decay

  const damping = audioCtx.createBiquadFilter();
  damping.type = 'lowpass';
  damping.frequency.value = 4000;

  const wetGain = audioCtx.createGain();
  wetGain.gain.value = 0.4;

  input.connect(delay);
  delay.connect(damping);
  damping.connect(feedback);
  feedback.connect(delay); // feedback loop
  damping.connect(wetGain).connect(output);


  return { input, output };
}
function play(toggle) {

  if (toggle) {
    source.start();
  } else {
    source.stop();
  }
}

function reverb(room, hall) {
  if (room) {
  // 리버브 선택: room 또는 hall
	// Dry/Wet routing
	source.disconnect();
	const { input: reverbIn, output: reverbOut } = createRoomReverb();
	source.connect(dryGain).connect(audioCtx.destination);
	source.connect(reverbIn);
	reverbOut.connect(audioCtx.destination);
	console.log("room reverb on");
  } else if (hall) {
	source.disconnect();
	const { input: reverbIn, output: reverbOut } = createHallReverb(); // 또는 */createRoomReverb()
	source.connect(dryGain).connect(audioCtx.destination);
	source.connect(reverbIn);
	reverbOut.connect(audioCtx.destination);
	console.log("hall reverb on");
  }else {
        source.disconnect();
        source.connect(audioCtx.destination);
        console.log("reverb off");
  }
}
</script>

</head>
<body>

  <pre>
  play / stop : 
  <button id="playButton" class="toggle-btn toggle-off">Play</button>
  </pre>
  <pre>
  room reverb : 
  <button id="roomButton" class="toggle-btn toggle-off">OFF</button>
  hall reverb : 
  <button id="hallButton" class="toggle-btn toggle-off">OFF</button>
  </pre>
  <script>
    const roomButton = document.getElementById('roomButton');
    let isRoomReverbOn = false;
    const hallButton = document.getElementById('hallButton');
    let isHallReverbOn = false;
	  
    roomButton.addEventListener('click', () => {
      isRoomReverbOn = !isRoomReverbOn;
      if (isRoomReverbOn) {
        roomButton.textContent = 'OFF';
        roomButton.classList.remove('toggle-off');
        roomButton.classList.add('toggle-on');
      } else {
        roomButton.textContent = 'ON';
        roomButton.classList.remove('toggle-on');
        roomButton.classList.add('toggle-off');
	hallButton.textContent = 'OFF';
        hallButton.classList.remove('toggle-off');
        hallButton.classList.add('toggle-on');
	isHallReverbOn = false;
      }
      reverb(isRoomReverbOn, isHallReverbOn);
    });


    hallButton.addEventListener('click', () => {
      isHallReverbOn = !isHallReverbOn;
      if (isHallReverbOn) {
        hallButton.textContent = 'OFF';
        hallButton.classList.remove('toggle-off');
        hallButton.classList.add('toggle-on');
      } else {
        hallButton.textContent = 'ON';
        hallButton.classList.remove('toggle-on');
        hallButton.classList.add('toggle-off');
	roomButton.textContent = 'OFF';
        roomButton.classList.remove('toggle-off');
        roomButton.classList.add('toggle-on');
        isRoomReverbOn = false;
      }
      reverb(isRoomReverbOn, isHallReverbOn);
    });
    const playButton = document.getElementById('playButton');
    let isPlayOn = false;
    playButton.addEventListener('click', () => {
      isPlayOn = !isPlayOn;
      if (isPlayOn) {
        playButton.textContent = 'Pause';
        playButton.classList.remove('toggle-off');
        playButton.classList.add('toggle-on');
      } else {
        playButton.textContent = 'Play';
        playButton.classList.remove('toggle-on');
        playButton.classList.add('toggle-off');
      }
      play(isPlayOn);
    });
  </script>

</body>
</html>

